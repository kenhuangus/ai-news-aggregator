---
phase: 04-prompt-abstraction
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - agents/analyzers/news_analyzer.py
  - agents/analyzers/research_analyzer.py
  - agents/analyzers/social_analyzer.py
  - agents/analyzers/reddit_analyzer.py
  - agents/base.py
  - agents/orchestrator.py
  - agents/link_enricher.py
  - agents/gatherers/link_follower.py
  - agents/ecosystem_context.py
  - run_pipeline.py
autonomous: true

must_haves:
  truths:
    - "Analyzers load prompts from PromptAccessor instead of class constants"
    - "Orchestrator loads prompts from PromptAccessor instead of inline strings"
    - "Utility agents load prompts from PromptAccessor"
    - "Pipeline loads prompts.yaml at startup and passes PromptAccessor to components"
    - "Editing prompts.yaml changes pipeline behavior without code changes"
  artifacts:
    - path: "agents/analyzers/news_analyzer.py"
      provides: "News analyzer using prompt config"
      contains: "prompt_accessor"
    - path: "agents/orchestrator.py"
      provides: "Orchestrator using prompt config"
      contains: "prompt_accessor"
    - path: "run_pipeline.py"
      provides: "Pipeline entry loading prompts"
      contains: "load_prompts"
  key_links:
    - from: "run_pipeline.py"
      to: "agents/config/prompts.py"
      via: "imports load_prompts"
      pattern: "from agents.config.prompts import"
    - from: "agents/orchestrator.py"
      to: "PromptAccessor"
      via: "receives in constructor"
      pattern: "prompt_accessor"
---

<objective>
Integrate prompt loading throughout the pipeline, replacing hardcoded prompts with config-based loading.

Purpose: Complete the prompt abstraction by wiring all components to use PromptAccessor, enabling runtime prompt customization.

Output: All agents and pipeline components use prompts from config/prompts.yaml.
</objective>

<execution_context>
@/Users/ryand/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryand/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-prompt-abstraction/04-CONTEXT.md
@.planning/phases/04-prompt-abstraction/04-01-SUMMARY.md
@.planning/phases/04-prompt-abstraction/04-02-SUMMARY.md
@agents/base.py
@agents/orchestrator.py
@run_pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BaseAnalyzer and analyzers to use PromptAccessor</name>
  <files>agents/base.py, agents/analyzers/news_analyzer.py, agents/analyzers/research_analyzer.py, agents/analyzers/social_analyzer.py, agents/analyzers/reddit_analyzer.py</files>
  <action>
**In agents/base.py:**

1. Update BaseAnalyzer.__init__ to accept optional `prompt_accessor: Optional[PromptAccessor] = None`
2. Store as `self.prompt_accessor`
3. Add import: `from .config.prompts import PromptAccessor`

**In each analyzer (news, research, social, reddit):**

1. Keep class-level prompt constants as FALLBACK (for backwards compatibility during migration)
2. Update `_get_batch_analysis_prompt()` to use PromptAccessor if available:
   ```python
   def _get_batch_analysis_prompt(self, items_context, batch_index, total_batches):
       if self.prompt_accessor:
           return self.prompt_accessor.get_analyzer_prompt(
               self.category, 'batch_analysis',
               {'batch_index': batch_index + 1, 'total_batches': total_batches, 'items_context': items_context}
           )
       # Fallback to class constant
       return self.BATCH_ANALYSIS_PROMPT.format(...)
   ```

3. Update `_get_ranking_prompt()` similarly
4. For news_analyzer: also update `_filter_with_llm()` and small batch analysis
5. Keep AI_KEYWORDS in news_analyzer (not a prompt, stays in code)

**Pattern for all analyzers:**
- Check if `self.prompt_accessor` exists
- If yes: use `get_analyzer_prompt(self.category, prompt_type, context)`
- If no: fall back to class constant (backwards compat)

This allows gradual migration and testing.
  </action>
  <verify>
```bash
python3 -c "
from agents.analyzers.news_analyzer import NewsAnalyzer
from agents.config.prompts import load_prompts, PromptAccessor

# Test without prompt_accessor (backwards compat)
analyzer = NewsAnalyzer()
prompt = analyzer._get_batch_analysis_prompt('test items', 0, 1)
assert 'AI news analyst' in prompt, 'Fallback prompt should work'
print('Backwards compat OK')

# Test with prompt_accessor
config = load_prompts('./config')
accessor = PromptAccessor(config)
analyzer2 = NewsAnalyzer(prompt_accessor=accessor)
prompt2 = analyzer2._get_batch_analysis_prompt('test items', 0, 1)
assert 'AI news analyst' in prompt2, 'Config prompt should work'
print('PromptAccessor integration OK')
"
```
  </verify>
  <done>Analyzers use PromptAccessor when available, fall back to class constants otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Update orchestrator and utilities to use PromptAccessor</name>
  <files>agents/orchestrator.py, agents/link_enricher.py, agents/gatherers/link_follower.py, agents/ecosystem_context.py</files>
  <action>
**In agents/orchestrator.py:**

1. Update MainOrchestrator.__init__ to accept `prompt_accessor: Optional[PromptAccessor] = None`
2. Update `_detect_cross_category_topics()`:
   ```python
   if self.prompt_accessor:
       prompt = self.prompt_accessor.get_orchestration_prompt(
           'topic_detection', {'context': context}
       )
   else:
       prompt = f"""Analyze the following category reports..."""  # Keep inline as fallback
   ```
3. Update `_generate_executive_summary()` similarly

**In agents/link_enricher.py:**

1. Update LinkEnricher.__init__ to accept `prompt_accessor: Optional[PromptAccessor] = None`
2. Update `_enrich_text()` to use accessor:
   ```python
   if self.prompt_accessor:
       prompt = self.prompt_accessor.get_post_processing_prompt(
           'link_enrichment',
           {'date': self.date, 'items_json': items_json, 'text': text}
       )
   else:
       prompt = f"""You are a link enrichment agent..."""
   ```

**In agents/gatherers/link_follower.py:**

1. Update LinkFollower.__init__ to accept `prompt_accessor: Optional[PromptAccessor] = None`
2. Update `should_follow_link()` to use accessor

**In agents/ecosystem_context.py:**

1. Update EcosystemContextManager to accept `prompt_accessor: Optional[PromptAccessor] = None`
2. Update `enrich_from_news()` to use accessor instead of class constant ENRICHMENT_PROMPT
  </action>
  <verify>
```bash
python3 -c "
from agents.orchestrator import MainOrchestrator
from agents.link_enricher import LinkEnricher
print('Orchestrator and utilities import OK')
"
```
  </verify>
  <done>Orchestrator and utility agents support PromptAccessor</done>
</task>

<task type="auto">
  <name>Task 3: Wire prompt loading in run_pipeline.py and orchestrator</name>
  <files>run_pipeline.py, agents/orchestrator.py</files>
  <action>
Update run_pipeline.py to load prompts and wire through orchestrator to components:

1. Add import:
   ```python
   from agents.config.prompts import load_prompts, PromptAccessor
   ```

2. In main() after loading provider config, load prompts:
   ```python
   # Load prompt configuration
   prompt_config = load_prompts(args.config_dir)
   prompt_accessor = PromptAccessor(prompt_config)
   logger.info(f"Loaded prompts from {args.config_dir}/prompts.yaml")
   ```

3. Pass prompt_accessor to MainOrchestrator:
   ```python
   orchestrator = MainOrchestrator(
       llm_client=llm_client,
       async_client=async_client,
       config_dir=args.config_dir,
       data_dir=args.data_dir,
       web_dir=args.web_dir,
       prompt_accessor=prompt_accessor,  # NEW
       ...
   )
   ```

4. Update MainOrchestrator to pass prompt_accessor to:
   - All analyzers (in __init__ where they're created)
   - LinkEnricher (when instantiated in orchestrate())
   - EcosystemContextManager (when used)
   - LinkFollower (if used directly)

**Error handling:**
- If prompts.yaml missing, load_prompts will exit with helpful error (already implemented in 04-01)
- This makes prompts.yaml required for the pipeline to run
  </action>
  <verify>
```bash
# Test that pipeline starts (won't complete without API keys, but should load prompts)
cd /Users/ryand/Code/AATF/ai-news-aggregator
python3 -c "
import sys
sys.argv = ['run_pipeline.py', '--config-dir', './config', '--data-dir', './data', '--web-dir', './web']

# Just test the loading part
from agents.config.prompts import load_prompts, PromptAccessor
config = load_prompts('./config')
accessor = PromptAccessor(config)
print(f'Pipeline can load prompts: {len(config.analysis)} analyzers configured')
"
```
  </verify>
  <done>Pipeline loads prompts at startup and passes PromptAccessor to all components</done>
</task>

</tasks>

<verification>
1. All imports work:
   ```bash
   python3 -c "
   from agents.base import BaseAnalyzer
   from agents.orchestrator import MainOrchestrator
   from agents.link_enricher import LinkEnricher
   from agents.gatherers.link_follower import LinkFollower
   from agents.ecosystem_context import EcosystemContextManager
   print('All imports OK')
   "
   ```

2. Backwards compatibility (no prompt_accessor):
   ```bash
   python3 -c "
   from agents.analyzers.news_analyzer import NewsAnalyzer
   analyzer = NewsAnalyzer()  # No prompt_accessor
   prompt = analyzer._get_batch_analysis_prompt('items', 0, 1)
   assert len(prompt) > 100, 'Fallback prompt should work'
   print('Backwards compat OK')
   "
   ```

3. Config-based prompts work:
   ```bash
   python3 -c "
   from agents.analyzers.news_analyzer import NewsAnalyzer
   from agents.config.prompts import load_prompts, PromptAccessor
   accessor = PromptAccessor(load_prompts('./config'))
   analyzer = NewsAnalyzer(prompt_accessor=accessor)
   prompt = analyzer._get_batch_analysis_prompt('items', 0, 1)
   assert len(prompt) > 100
   print('Config-based prompts OK')
   "
   ```

4. Prompt changes are reflected:
   ```bash
   # This is a manual verification - modify a prompt and confirm change is visible
   echo "Edit config/prompts.yaml, change a word, and verify it appears in the prompt"
   ```
</verification>

<success_criteria>
- All analyzers support PromptAccessor with fallback to class constants
- Orchestrator and utilities support PromptAccessor
- run_pipeline.py loads prompts and passes to components
- Existing tests/usage works (backwards compatibility)
- Users can modify prompts.yaml and see changes in pipeline runs
</success_criteria>

<output>
After completion, create `.planning/phases/04-prompt-abstraction/04-03-SUMMARY.md`
</output>
