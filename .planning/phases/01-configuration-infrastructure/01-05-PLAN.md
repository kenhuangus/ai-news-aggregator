# Plan 01-05: Migration Bug Fixes

**Phase:** 01-configuration-infrastructure
**Type:** Gap closure from UAT
**Source:** 01-UAT.md

## Goal

Fix migration bugs identified during UAT so that auto-migration creates correct providers.yaml with env var references.

## Context

UAT found these issues in `agents/config/migration.py`:
1. Backup filename: `.env` renamed to `.env.env.backup` instead of `.env.backup`
2. Copies literal API key values instead of `${ANTHROPIC_API_KEY}` references
3. Image example uses wrong model (gemini-2.0) and includes unnecessary endpoint
4. Image provider env vars not migrated
5. `.env.backup*` not in .gitignore

## Tasks

### Task 1: Fix backup filename logic

**File:** `agents/config/migration.py`

**Problem:** Line 119 uses `env_path.with_suffix('.env.backup')` but for a file named `.env`, the entire name is the suffix.

**Fix:** Use string manipulation instead of Path.with_suffix():
```python
# Before
backup_path = env_path.with_suffix('.env.backup')

# After
backup_path = env_path.parent / (env_path.name + '.backup')
```

Similarly fix line 122 for timestamped backups.

### Task 2: Use ${VAR} references instead of literal values

**File:** `agents/config/migration.py`

**Problem:** Lines 97-102 write literal values from env vars.

**Fix:** Write `${VAR}` syntax that the loader will interpolate:
```python
# Before
yaml_content = f'''...
  api_key: "{detected['llm']['api_key']}"
  base_url: "{detected['llm']['base_url']}"
...'''

# After
yaml_content = '''...
  api_key: "${ANTHROPIC_API_KEY}"
  base_url: "${ANTHROPIC_API_BASE}"
  model: "${ANTHROPIC_MODEL}"
...'''
```

Note: Only write the model line if ANTHROPIC_MODEL was set, otherwise use a sensible default.

### Task 3: Fix image provider example in migration template

**File:** `agents/config/migration.py`

**Problem:** Lines 104-110 have wrong gemini-2.0 values.

**Fix:** Match providers.yaml.example:
```python
# Before
# image:
#   api_key: "your-image-api-key"
#   endpoint: "https://generativelanguage.googleapis.com/v1beta"
#   model: "gemini-2.0-flash-exp-image-generation"

# After
# image:
#   mode: "native"
#   api_key: "${GEMINI_API_KEY}"
#   model: "gemini-3-pro-image-preview"
```

### Task 4: Add image provider env var migration

**File:** `agents/config/migration.py`

**Problem:** Image config not migrated even if GEMINI_API_KEY exists.

**Fix:**
1. Add to ENV_VAR_MAPPING:
```python
'GEMINI_API_KEY': ('image', 'api_key'),
```

2. If GEMINI_API_KEY detected, write uncommented image section with ${GEMINI_API_KEY} reference.

### Task 5: Add .env.backup* to .gitignore

**File:** `.gitignore`

**Fix:** Add pattern to ignore backup files:
```
.env.backup*
```

## Verification

After fixes, migration should:
1. Rename `.env` to `.env.backup` (not `.env.env.backup`)
2. Create providers.yaml with `${ANTHROPIC_API_KEY}` etc. (not literal values)
3. Include image config if GEMINI_API_KEY is set
4. Use correct gemini-3-pro-image-preview model
5. Backup files stay out of git

## Commit Strategy

Single commit: `fix(config): migration bugs - use env var refs, fix backup naming, add image migration`
