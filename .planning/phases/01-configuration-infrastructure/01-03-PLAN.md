---
phase: 01-configuration-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - run_pipeline.py
  - agents/orchestrator.py
  - generators/hero_generator.py
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Pipeline loads config from providers.yaml at startup before any agent work"
    - "Orchestrator creates LLM clients using from_config() with loaded ProviderConfig"
    - "Hero generator uses image config from ProviderConfig (or skips if not configured)"
    - "providers.yaml is gitignored (user's secrets stay out of repo)"
    - "Pipeline exits with clear error if config invalid, not cryptic runtime error"
  artifacts:
    - path: "run_pipeline.py"
      provides: "Config loading at pipeline entry point"
      contains: "load_config"
    - path: "agents/orchestrator.py"
      provides: "Config-based client initialization"
      contains: "from_config"
    - path: "generators/hero_generator.py"
      provides: "Optional image provider support"
      contains: "ImageProviderConfig"
    - path: ".gitignore"
      provides: "Ignore user config"
      contains: "providers.yaml"
  key_links:
    - from: "run_pipeline.py"
      to: "agents/config"
      via: "load_config import"
      pattern: "from agents.config import load_config"
    - from: "agents/orchestrator.py"
      to: "agents/llm_client.py"
      via: "from_config call"
      pattern: "\\.from_config\\("
    - from: "generators/hero_generator.py"
      to: "agents/config/schema.py"
      via: "ImageProviderConfig"
      pattern: "ImageProviderConfig"
---

<objective>
Integrate the configuration system into the pipeline entry point, orchestrator, and hero generator so the entire system loads config at startup.

Purpose: Complete the configuration infrastructure so users can run the pipeline with providers.yaml instead of scattered env vars.
Output: Working pipeline that validates config at startup and uses ProviderConfig throughout.
</objective>

<execution_context>
@/Users/ryand/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryand/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-configuration-infrastructure/01-RESEARCH.md
@.planning/phases/01-configuration-infrastructure/01-CONTEXT.md
@.planning/phases/01-configuration-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-configuration-infrastructure/01-02-SUMMARY.md

# Reference files
@run_pipeline.py
@agents/orchestrator.py
@generators/hero_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate config loading into pipeline entry point</name>
  <files>run_pipeline.py</files>
  <action>
Update `run_pipeline.py` to load config at startup before creating the orchestrator.

1. Add import at top:
```python
from agents.config import load_config, ProviderConfig
```

2. Update `run_pipeline()` function to load config first:
```python
async def run_pipeline(config_dir: str, data_dir: str, web_dir: str, target_date: str = None) -> bool:
    """
    Run the complete multi-agent pipeline.

    Args:
        config_dir: Directory containing configuration files
        data_dir: Directory for data storage
        web_dir: Directory for generated website
        target_date: Report date (YYYY-MM-DD). Coverage is day before.

    Returns:
        True if successful, False otherwise.
    """
    start_time = datetime.now()
    logger.info("=" * 60)
    logger.info("AI NEWS AGGREGATION PIPELINE - MULTI-AGENT ARCHITECTURE")
    logger.info(f"Start time: {start_time}")
    logger.info("=" * 60)

    # Load and validate configuration FIRST
    # This will auto-migrate from env vars if needed, or exit with clear error
    logger.info("Loading provider configuration...")
    provider_config = load_config(config_dir)

    # Get additional configuration from environment (CLI args override env vars)
    lookback_hours = int(os.getenv('LOOKBACK_HOURS', '24'))
    if not target_date:
        target_date = os.getenv('TARGET_DATE', '')

    orchestrator = None

    try:
        # Initialize orchestrator with provider config
        orchestrator = MainOrchestrator(
            config_dir=config_dir,
            data_dir=data_dir,
            web_dir=web_dir,
            lookback_hours=lookback_hours,
            target_date=target_date if target_date else None,
            provider_config=provider_config  # NEW: pass config
        )

        # Rest of the function stays the same...
```

Note: The orchestrator will be updated in Task 2 to accept `provider_config` parameter.
  </action>
  <verify>
```bash
cd /Users/ryand/Code/AATF/ai-news-aggregator
grep -n "load_config" run_pipeline.py && echo "load_config import: OK"
grep -n "provider_config" run_pipeline.py && echo "provider_config usage: OK"
```
  </verify>
  <done>Pipeline loads and validates config at startup before any agent work</done>
</task>

<task type="auto">
  <name>Task 2: Update orchestrator to use config-based client initialization</name>
  <files>agents/orchestrator.py</files>
  <action>
Update `agents/orchestrator.py` to accept ProviderConfig and use `from_config()` for LLM clients.

1. Add import:
```python
from .config import ProviderConfig
```

2. Update `MainOrchestrator.__init__()` signature and body:
```python
def __init__(
    self,
    config_dir: str = './config',
    data_dir: str = './data',
    web_dir: str = './web',
    lookback_hours: int = 24,
    target_date: Optional[str] = None,
    provider_config: Optional[ProviderConfig] = None  # NEW
):
    """
    Initialize orchestrator.

    Args:
        config_dir: Directory containing configuration files.
        data_dir: Directory for storing data.
        web_dir: Directory for generated HTML.
        lookback_hours: Hours to look back for items.
        target_date: Specific date to collect (YYYY-MM-DD format).
        provider_config: Provider configuration. If None, loads from config_dir.
    """
    self.config_dir = config_dir
    self.data_dir = data_dir
    self.web_dir = web_dir
    self.lookback_hours = lookback_hours
    self.target_date = target_date or self._get_today()
    self.provider_config = provider_config

    # Initialize LLM clients from config
    if provider_config:
        self.llm_client = AnthropicClient.from_config(provider_config.llm)
        self.async_client = AsyncAnthropicClient.from_config(provider_config.llm)
    else:
        # Fallback to env vars for backwards compatibility
        self.llm_client = AnthropicClient()
        self.async_client = AsyncAnthropicClient()
```

3. Update hero generator initialization to pass image config:
```python
# Initialize hero generator if available AND configured
self.hero_generator: Optional['HeroGenerator'] = None
if HERO_GENERATOR_AVAILABLE:
    # Check if image provider is configured
    image_config = provider_config.image if provider_config else None
    if image_config:
        try:
            self.hero_generator = HeroGenerator.from_config(image_config)
            logger.info("Hero generator initialized from config")
        except Exception as e:
            logger.warning(f"Hero generator not available: {e}")
    else:
        logger.info("Hero image generation disabled (no image provider configured)")
```

Note: HeroGenerator.from_config() will be added in Task 3.
  </action>
  <verify>
```bash
cd /Users/ryand/Code/AATF/ai-news-aggregator
grep -n "provider_config" agents/orchestrator.py && echo "provider_config in orchestrator: OK"
grep -n "from_config" agents/orchestrator.py && echo "from_config usage: OK"
```
  </verify>
  <done>Orchestrator uses from_config() for LLM clients and passes image config to hero generator</done>
</task>

<task type="auto">
  <name>Task 3: Update hero generator for config-based initialization and gitignore</name>
  <files>generators/hero_generator.py, .gitignore</files>
  <action>
Update `generators/hero_generator.py` to support config-based initialization.

1. Add import at top:
```python
from typing import TYPE_CHECKING
if TYPE_CHECKING:
    from agents.config import ImageProviderConfig
```

2. Update `__init__()` to accept optional config values:
```python
def __init__(
    self,
    api_key: Optional[str] = None,
    endpoint: Optional[str] = None,
    model: Optional[str] = None
):
    """
    Initialize hero generator.

    Args:
        api_key: API key for image generation. Falls back to ANTHROPIC_API_KEY env var.
        endpoint: API endpoint URL. Falls back to class default.
        model: Model name. Falls back to class default.
    """
    self.api_key = api_key or os.environ.get("ANTHROPIC_API_KEY")
    self.endpoint = endpoint or self.ENDPOINT
    self.model = model or self.MODEL

    if not self.api_key:
        raise ValueError("Image API key required (api_key parameter or ANTHROPIC_API_KEY env var)")

    # Verify skunk reference exists
    if not self.SKUNK_REFERENCE.exists():
        raise FileNotFoundError(f"Skunk reference image not found at {self.SKUNK_REFERENCE}")

    logger.info(f"HeroGenerator initialized with endpoint={self.endpoint}, model={self.model}")
```

3. Add class method for config-based initialization:
```python
@classmethod
def from_config(cls, config: 'ImageProviderConfig') -> 'HeroGenerator':
    """
    Create hero generator from ImageProviderConfig.

    Args:
        config: ImageProviderConfig with api_key, endpoint, model

    Returns:
        Configured HeroGenerator instance
    """
    return cls(
        api_key=config.api_key,
        endpoint=config.endpoint,
        model=config.model
    )
```

4. Update `generate()` method to use instance attributes instead of class constants:
- Replace `self.ENDPOINT` with `self.endpoint`
- Replace `self.MODEL` with `self.model`
- Replace `self.api_key` (already used)

5. Add providers.yaml to `.gitignore`:
```
# Provider configuration (contains API keys)
config/providers.yaml
```

Add this in the "Environment variables" section or create a new section.
  </action>
  <verify>
```bash
cd /Users/ryand/Code/AATF/ai-news-aggregator

# Verify from_config exists
grep -n "from_config" generators/hero_generator.py && echo "HeroGenerator.from_config: OK"

# Verify gitignore
grep -n "providers.yaml" .gitignore && echo "Gitignore updated: OK"

# Verify the generator can be imported
python3 -c "from generators.hero_generator import HeroGenerator; print('HeroGenerator import: OK')"
```
  </verify>
  <done>Hero generator supports config-based init, providers.yaml is gitignored</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ryand/Code/AATF/ai-news-aggregator

# 1. Verify run_pipeline.py loads config
python3 -c "
import ast
with open('run_pipeline.py') as f:
    tree = ast.parse(f.read())

# Check for load_config import
imports = [node for node in ast.walk(tree) if isinstance(node, ast.ImportFrom)]
has_load_config = any(
    node.module == 'agents.config' and
    any(alias.name == 'load_config' for alias in node.names)
    for node in imports
)
assert has_load_config, 'load_config import missing'
print('run_pipeline imports load_config: OK')
"

# 2. Verify orchestrator accepts provider_config
python3 -c "
import inspect
from agents.orchestrator import MainOrchestrator

sig = inspect.signature(MainOrchestrator.__init__)
params = list(sig.parameters.keys())
assert 'provider_config' in params, 'provider_config param missing'
print('Orchestrator accepts provider_config: OK')
"

# 3. Verify hero generator from_config
python3 -c "
from generators.hero_generator import HeroGenerator
assert hasattr(HeroGenerator, 'from_config'), 'from_config method missing'
print('HeroGenerator.from_config: OK')
"

# 4. Verify gitignore
python3 -c "
with open('.gitignore') as f:
    content = f.read()
assert 'providers.yaml' in content, 'providers.yaml not in gitignore'
print('Gitignore includes providers.yaml: OK')
"

# 5. Verify end-to-end import chain
python3 -c "
from agents.config import load_config, ProviderConfig
from agents.orchestrator import MainOrchestrator
from agents.llm_client import AnthropicClient, AsyncAnthropicClient
from generators.hero_generator import HeroGenerator
print('Full import chain: OK')
"

# 6. Verify config loading fails gracefully without providers.yaml
python3 -c "
import tempfile
import os
import sys
from pathlib import Path

# Create temp dir without providers.yaml
with tempfile.TemporaryDirectory() as tmpdir:
    # Write example file
    example = Path(tmpdir) / 'providers.yaml.example'
    example.write_text('llm:\\n  api_key: test')

    # Try to load config (should fail with helpful message)
    import io
    old_stderr = sys.stderr
    sys.stderr = io.StringIO()

    try:
        from agents.config import load_config
        load_config(tmpdir, auto_migrate=False)
        print('ERROR: Should have exited')
    except SystemExit:
        output = sys.stderr.getvalue()
        sys.stderr = old_stderr
        if 'not found' in output.lower() or 'providers.yaml' in output:
            print('Config validation error message: OK')
        else:
            print(f'Unexpected output: {output}')
"

echo "All verifications passed"
```
</verification>

<success_criteria>
- run_pipeline.py loads config via load_config() before creating orchestrator
- MainOrchestrator accepts provider_config parameter
- Orchestrator uses from_config() for LLM client initialization
- Hero generator has from_config() class method
- Hero generator uses instance attributes for endpoint/model
- .gitignore includes config/providers.yaml
- Pipeline exits cleanly if config is missing/invalid
- All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration-infrastructure/01-03-SUMMARY.md`
</output>
