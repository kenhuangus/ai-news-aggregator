---
phase: 03-image-provider-support
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - generators/hero_generator.py
  - scripts/regenerate_hero.py
autonomous: true

must_haves:
  truths:
    - "HeroGenerator uses ImageClient abstraction for image generation"
    - "Hero generation gracefully skips when no image provider configured"
    - "User sees clear WARNING log explaining why hero was skipped"
    - "Regenerate script works with new ImageClient abstraction"
  artifacts:
    - path: "generators/hero_generator.py"
      provides: "Hero generation using unified ImageClient"
      contains: "ImageClient"
    - path: "scripts/regenerate_hero.py"
      provides: "CLI hero regeneration using config"
      contains: "load_config"
  key_links:
    - from: "generators/hero_generator.py:HeroGenerator"
      to: "generators/image_client.py:ImageClient"
      via: "from_config factory method"
      pattern: "ImageClient\\.from_config"
    - from: "generators/hero_generator.py"
      to: "agents/config/schema.py:ImageProviderConfig"
      via: "config parameter"
      pattern: "ImageProviderConfig"
---

<objective>
Update HeroGenerator to use the new ImageClient abstraction and add graceful skip logic when no image provider is configured.

Purpose: Complete the image provider support by integrating the new client abstraction into the existing hero generation workflow. Users without image config should see a clear warning but the pipeline should continue.

Output:
- Updated `generators/hero_generator.py` using ImageClient.from_config() internally
- Updated `scripts/regenerate_hero.py` to use config-based initialization
- Graceful skip with clear WARNING log messages
</objective>

<execution_context>
@/Users/ryand/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ryand/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-provider-support/03-CONTEXT.md
@.planning/phases/03-image-provider-support/03-01-SUMMARY.md
@agents/config/schema.py
@generators/hero_generator.py
@generators/image_client.py
@scripts/regenerate_hero.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update HeroGenerator to use ImageClient abstraction</name>
  <files>generators/hero_generator.py</files>
  <action>
Refactor HeroGenerator to use the new ImageClient abstraction:

1. **Update imports:**
   - Add `from generators.image_client import ImageClient, BaseImageClient, ImageResponse`
   - Keep TYPE_CHECKING import for ImageProviderConfig

2. **Update __init__ signature:**
   - Accept `client: Optional[BaseImageClient] = None` instead of api_key/endpoint/model
   - Keep the old signature for backwards compatibility (api_key, endpoint, model) but mark as deprecated
   - If client is None and api_key is provided, create OpenAICompatibleClient internally (legacy mode)
   - Store the client: `self.client = client`

3. **Update from_config classmethod:**
   - Create ImageClient via factory: `client = ImageClient.from_config(config)`
   - Return `cls(client=client)`

4. **Update generate() method:**
   - Replace direct requests.post with `await self.client.generate()`
   - Pass prompt, reference_image (skunk bytes), aspect_ratio, image_size
   - Receive ImageResponse and extract image_data
   - Keep the same PNG->WebP optimization flow
   - Update error handling to use generic exception handling (client handles specifics)

5. **Update edit() method:**
   - Similar refactor to use self.client.generate() with edit prompt
   - Edit is essentially generate with different prompt and reference image

6. **Remove class constants ENDPOINT and MODEL:**
   - These are now handled by config/client
   - Keep SKUNK_REFERENCE and VISUAL_MAPPINGS

7. **Keep helper methods unchanged:**
   - _extract_visuals, _get_topic_names, _get_topic_summaries, _strip_markdown_links
   - generate_sync, edit_sync (wrapper methods)
  </action>
  <verify>
Verify the file has the new imports and from_config method:
```bash
grep -E "(from generators.image_client|ImageClient\.from_config)" generators/hero_generator.py
```
  </verify>
  <done>HeroGenerator uses ImageClient abstraction internally, with backwards-compatible legacy initialization</done>
</task>

<task type="auto">
  <name>Task 2: Add graceful skip logic with clear logging</name>
  <files>generators/hero_generator.py</files>
  <action>
Add a module-level function and update from_config to support graceful skipping:

1. **Add initialize_hero_generator function:**
```python
def initialize_hero_generator(config: Optional['ImageProviderConfig']) -> Optional['HeroGenerator']:
    """
    Initialize HeroGenerator from config, returning None if not configured.

    Args:
        config: ImageProviderConfig or None

    Returns:
        HeroGenerator if configured, None otherwise (with warning logged)
    """
    if config is None:
        logger.warning(
            "Hero image generation disabled: no 'image' section in providers.yaml. "
            "To enable, add image provider config. You can run "
            "scripts/regenerate_hero.py later to generate images."
        )
        return None

    try:
        return HeroGenerator.from_config(config)
    except ValueError as e:
        logger.warning(
            f"Hero image generation disabled: {e}. "
            "Check your image provider configuration in providers.yaml."
        )
        return None
    except Exception as e:
        logger.warning(
            f"Hero image generation disabled due to initialization error: {e}. "
            "Pipeline will continue without hero images."
        )
        return None
```

2. **Update HeroGenerator.from_config error messages:**
   - If ImageClient.from_config fails, include mode-specific troubleshooting
   - For native mode: "Verify your GOOGLE_API_KEY and ensure google-genai SDK is installed"
   - For openai-compatible mode: "Verify your endpoint and api_key are correct"

3. **Ensure JSON output has null values when skipped:**
   - When hero generation is skipped, the pipeline should set:
     - `hero_image_url: null`
     - `hero_image_prompt: null`
   - This is handled by the orchestrator, but document in comments
  </action>
  <verify>
Verify the initialize_hero_generator function exists:
```bash
grep -A 5 "def initialize_hero_generator" generators/hero_generator.py
```
  </verify>
  <done>initialize_hero_generator returns None with WARNING log when no image config; HeroGenerator.from_config has mode-specific error messages</done>
</task>

<task type="auto">
  <name>Task 3: Update regenerate_hero.py to use config</name>
  <files>scripts/regenerate_hero.py</files>
  <action>
Update the regenerate_hero.py script to use configuration-based initialization:

1. **Add config loading:**
```python
from agents.config import load_config
from agents.config.schema import ImageProviderConfig
```

2. **Update generator initialization in main():**
```python
# Initialize generator from config
try:
    config_dir = str(project_root / "config")
    provider_config = load_config(config_dir)

    if provider_config.image is None:
        logger.error(
            "No image provider configured in config/providers.yaml. "
            "Add an 'image' section with api_key and mode to enable hero generation."
        )
        sys.exit(1)

    generator = HeroGenerator.from_config(provider_config.image)
except Exception as e:
    logger.error(f"Failed to initialize hero generator: {e}")
    sys.exit(1)
```

3. **Remove direct HeroGenerator() calls:**
   - The script should not allow running without proper config
   - Remove fallback to ANTHROPIC_API_KEY env var (that was RDSec-specific)

4. **Add helpful error messages:**
   - If providers.yaml doesn't exist: suggest creating from example
   - If image section missing: explain how to add it
  </action>
  <verify>
Verify the script uses load_config:
```bash
grep "load_config" scripts/regenerate_hero.py
```
  </verify>
  <done>regenerate_hero.py loads config from providers.yaml and fails with helpful error if no image provider configured</done>
</task>

</tasks>

<verification>
1. HeroGenerator.from_config uses ImageClient.from_config internally
2. initialize_hero_generator returns None with WARNING when no config
3. regenerate_hero.py uses load_config for initialization
4. Error messages are clear and include troubleshooting guidance
5. No breaking changes to existing HeroGenerator interface (backwards compatible)
</verification>

<success_criteria>
- HeroGenerator uses unified ImageClient abstraction
- Graceful skip with clear WARNING logs when no image provider configured
- regenerate_hero.py works with new config-based approach
- Pipeline can run without image provider (hero generation disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-provider-support/03-02-SUMMARY.md`
</output>
